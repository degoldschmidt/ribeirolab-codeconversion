%% Pre-Classification of grooming and exploiting
load([Variablesfolder 'ManualAnnotation0003A 07-Jan-2015.mat'])
behav_labels={'YFeedingEvents';'SFeedingEvents';'Grooming';'Rest';'Outside Y'};

spot_thr=2.2; %mm
behav_Colors=[238 96 8;...%Orange(Exploiting yeast (Feeding))
    0 0 0;...%Black (Exploiting sucrose (Feeding))
    204 153 0;...0 255 255;...%Mustard (Grooming)
    [0.6 0.6 0.6]*255;...%Gray (Resting)
    0 255 255]/255;
    
Area_covered_preClassif=cell(size(behav_labels));

for lbehav=1:length(behav_labels)-1
    Vartoplot=behav_labels{lbehav};
    display(Vartoplot)
    Area_covered_preClassif{lbehav}=[];
    if lbehav==1
        Area_covered_preClassif{length(behav_labels)}=[];
    end
    rows2plot=1:size(ManualAnnotation.(Vartoplot)(:,1),1);
    ltracecounter=0;
    for lrow=rows2plot
        ltracecounter=ltracecounter+1;
        ltrace=ManualAnnotation.(Vartoplot)(lrow,1);
        display([Vartoplot ' Bout ' num2str(rows2plot(ltracecounter))])
        lfly=ManualAnnotation.(Vartoplot)(lrow,4);
        Geometry=FlyDB(lfly).Geometry;
        range=ltrace:ManualAnnotation.(Vartoplot)(lrow,2);
        
        Spots=ManualAnnotation.(Vartoplot)(lrow,3);
        lsubs=Geometry(Spots);
        Dist2Spots=sqrt(sum(((Heads_Sm{lfly}-...
            repmat(FlyDB(lfly).WellPos(Spots,:),...
            length(Heads_Sm{lfly}),1)).^2),2))*params.px2mm;
        
        %% Find micromovement bouts inside time segment
        microstarts=find(conv(double(Micro_mov{lfly}==1),[1 -1])==1);
        microends=find(conv(double(Micro_mov{lfly}==1),[1 -1])==-1)-1;
        
        bout_micromovstart=find(microstarts<range(1),1,'last');
        bout_micromovend=find(microends>range(end),1,'first');
        
        for lmicrobout=bout_micromovstart:bout_micromovend
            framesmicro=microstarts(lmicrobout):microends(lmicrobout);
            if (sum(ismember(framesmicro,range))/length(framesmicro))>.5
                Area_covered_preClassif{lbehav}=[Area_covered_preClassif{lbehav};...
                    Areacovered_Dur{lfly}(microstarts(lmicrobout),:),sum(Steplength_Sm_h{lfly}(framesmicro)*params.px2mm)];
                
                if ((sum(Dist2Spots(framesmicro)>=spot_thr-.1)/length(framesmicro))>.5)&&(lbehav==1)
                    Area_covered_preClassif{length(behav_labels)}=[Area_covered_preClassif{length(behav_labels)};...
                    Areacovered_Dur{lfly}(microstarts(lmicrobout),:),sum(Steplength_Sm_h{lfly}(framesmicro)*params.px2mm)];
                end
            end
        end
        %% Save information of area coverage for rest bouts
        if lbehav==4 %Rest
            microstarts=find(conv(double(Micro_mov{lfly}==5),[1 -1])==1);
            microends=find(conv(double(Micro_mov{lfly}==5),[1 -1])==-1)-1;
            
            bout_micromovstart=find(microstarts<range(1),1,'last');
            bout_micromovend=find(microends>range(end),1,'first');
            
            for lmicrobout=bout_micromovstart:bout_micromovend
                framesmicro=microstarts(lmicrobout):microends(lmicrobout);
                if (sum(ismember(framesmicro,range))/length(framesmicro))>.5
                    Area_covered_preClassif{lbehav}=[Area_covered_preClassif{lbehav};...
                        Areacovered_Dur{lfly}(microstarts(lmicrobout),:),sum(Steplength_Sm_h{lfly}(framesmicro)*params.px2mm)];
                end
            end
        end
    end
end

%% Histogram of area coverage per sec
% display('Histogram of area coverage per sec')
% close all
% fig=figure('Position',[50 50 900 850],'Color','w');%
% hold on
% bins=[0:.1:6 Inf];
% FtSz=14;%20;
% counts=zeros(length(bins),length(behav_labels));
% for lbehav=1:length(behav_labels)-1
%     Vartoplot=behav_labels{lbehav};
%     counts(:,lbehav)=histc(Area_covered_preClassif{lbehav}(:,3),bins);
% end
% counts=counts(1:end-1,:);
% clear h
% h=bar(bins(1:end-1),counts./repmat(sum(counts),length(bins)-1,1));
% 
% for lhist=1:length(behav_labels)-1
%     set(h(lhist),'FaceColor',behav_Colors(lhist,:),'EdgeColor',behav_Colors(lhist,:));
% end
% font_style('Area covered during micromovement','Area covered per sec [px/s]',...
%     'Relative Frequency','normal','arial',FtSz)
% xlim([bins(1)-1 bins(end-1)+1])
% legend(h,behav_labels(1:end-1))
% 
% figname='Area covered during micromovement - Feeding, Grooming, Resting';
% print('-dpng','-r400',[DataSaving_dir_temp Exp_num '\Plots\Manual Ann\',...
%     figname '.png'])%'-r600'

%% Area covered vs duration
display('Area covered vs duration')
close all
fig=figure('Position',[50 50 900 850],'Color','w');%
hold on
bins=[0:.2:6 Inf];
FtSz=14;%20;
clear h
for lbehav=1:length(behav_labels)-1
    h(lbehav)=plot(Area_covered_preClassif{lbehav}(:,2),Area_covered_preClassif{lbehav}(:,1),...
        'o','Color',behav_Colors(lbehav,:),'MarkerFaceColor',behav_Colors(lbehav,:),...
        'MarkerSize',6);
end

plot([0:140],.25*[0:140]-.5,'--g')
plot([0:140],0.1*[0:140]+6,'--r')

font_style([],'Duration (s)',...
    'Area covered (px)','normal','arial',FtSz)

legend(h,behav_labels(1:end-1))

figname='Area covered vs duration of micromovement - Feeding, Grooming, Resting';
% print('-dpng','-r400',[DataSaving_dir_temp Exp_num '\Plots\Manual Ann\',...
%     figname '.png'])%'-r600'
%% Area covered vs distance covered
display('Area covered vs duration')
% close all
fig=figure('Position',[50 50 900 850],'Color','w');%
hold on
bins=[0:.2:6 Inf];
FtSz=14;%20;
clear h
for lbehav=1:length(behav_labels)-1
    h(lbehav)=plot(Area_covered_preClassif{lbehav}(:,4),Area_covered_preClassif{lbehav}(:,1),...
        'o','Color',behav_Colors(lbehav,:),'MarkerFaceColor',behav_Colors(lbehav,:),...
        'MarkerSize',6);
end

% plot([0:140],.25*[0:140]-.5,'--g')
% plot([0:140],0.1*[0:140]+6,'--r')

font_style([],'Distance covered (mm)',...
    'Area covered (px)','normal','arial',FtSz)

legend(h,behav_labels(1:end-1))

figname='Area covered vs duration of micromovement - Feeding, Grooming, Resting';
% print('-dpng','-r400',[DataSaving_dir_temp Exp_num '\Plots\Manual Ann\',...
%     figname '.png'])%'-r600'